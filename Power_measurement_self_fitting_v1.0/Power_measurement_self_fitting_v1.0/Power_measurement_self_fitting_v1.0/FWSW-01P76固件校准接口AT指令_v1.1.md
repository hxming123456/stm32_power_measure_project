# FWSW-01P76固件校准接口AT指令

  - 版本：1.1
  - 作者：武鹏飞
  - 日期：2017/7/27 10:41:52 

---

# 概述

本套AT指令集用于校准基于 FWSW-01P76 固件的模块。显然，模块的外部电路设计应当满足CSE7766的要求。校准需要在工厂模式下进行，关于工厂模式参考后文。

# 配置要求

通信软串口：

    9600 8n1
    RX(ESP8266->GPIO4)
    TX(ESP8266->GPIO5)

# AT指令返回值的约定

正常情况下是

    <可选的返回值>
    \r\nOK\r\n

出错时：

    <可选出错原因>
    \r\nERROR\r\n

# AT指令集

启动校准：

    发送：AT+C76START
    响应：OK
    说明：模块收到该指令后，开始测量功率、电压、电流；

读取模块实测值：

    发送：AT+C76CAPTURE
    响应：
        <CapturePower>,<CaptureCurrent>,<CaptureVoltage>
        OK
    说明：<CapturePower>,<CaptureCurrent>,<CaptureVoltage>，十进制表示，分别表示模块实际测到的功率、电流、电压，单位为mW、mA、mV；
         返回的值应该是至少读取3次之后的平均值（去掉偏差太大的值）；


完成校准并设定结果：

    发送：AT+C76END=<Result>,<PowerA>,<PowerB>,<CurrentA>,<CurrentB>,<VolgageOffset>
    响应：OK
    说明：<Result> 为1表示成功，后面参数有效，此时模块应记录或更新本次校准结果；
         <Result> 为0表示失败，后面参数无效，此时模块应忽略本次校准结果；
         <PowerA>,<PowerB>,<CurrentA>,<CurrentB>分别用十进制整数表示功率直线参数和电流直线参数，
            每个参数值应该为实际值保留两位小数（四舍五入）再乘以100，例如：
            如果实际功率直线斜率为2.467则PowerA应该这样计算 PowerA = 2.47 * 100 = 247； 
         <VolgageOffset> 十进制整数表示电压补偿参数；
         模块收到该指令后，停止测量功率、电压、电流；
         备注：这里假设直线模型为 y = Ax + B

# 注意点

  - AT+C76START指令之后，标准设备可以主动调整负载大小然后通过AT+C76CAPTURE读取模块实测值；
  - 当负载功率较小时，读取间隔应当增大。建议5W以下保证测量时间不小于10秒。
  - 整个校准过程由标准设备主动发起和结束，待测模块以AT+C76END为准选择是否存储(或更新)校准数据；

# 固件FWSW-01P76的校准策略

    功率、电流：根据标定值参数（<PowerA>,<PowerB>,<CurrentA>,<CurrentB>）做线性计算即可。
    电压：实测电压+补偿参数（<VolgageOffset>）。

注意：这里的标定值参数、补偿参数是带符号的。

# 固件的工厂模式（Factory Mode）

在此模式下，可以通过软串口进行数据烧录、硬件测试、参数校准等工作。针对于本固件的校准，应当在此模式下进行。

## 工厂模式的进入

场景一：未曾烧录数据

如果待测模块未曾烧录过数据（无论是手动或自动化烧写），上电后会自动进入工厂模式（同时有状态灯指示）。

场景二：已经烧录过数据

如果模块已经烧录过数据（无论是手动或自动化烧写），上电后模块不会自动进入工厂模式。模块会通过软串口向外发送探测数据（`factory?`），如果在一定时间内（100ms）收到来自测试治具（测试上位机、校准治具、测试底板或其等价装置）的正确响应(`factory!`)，则会进入工厂模式；否则，正常启动。

## 工厂模式的退出

当模块处于工厂模式，只有断电重启才会退出。


---

结束

---
